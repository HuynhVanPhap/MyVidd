<%- include("../layouts/header") %>
    <div class="container my-4">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="mt-4">
                    <%= video.title %>
                </h1>

                <p class="lead">
                    <a href="/channel/<%= video.user._id %>">
                        by <%= video.user.name %>
                    </a>
                </p>

                <hr>

                <p>
                    <%
                        const createdAt = new Date(video.createdAt);
                        const date = createdAt.getDate() + "";
                    %>

                    Posted on <%= date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear() %>
                </p>

                <hr>

                <input type="hidden" id="videoId" value="<%= video._id %>">
                <input type="hidden" id="category" value="<%= video.category %>">

                <video
                    id="videoPlayer"
                    controls
                    style="width: 100%;"
                    src="<%= baseUrl + video.filePath %>"
                    poster="<%= baseUrl + video.thumbnail %>"
                ></video>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-0">
                            <i class="fa fa-eye"></i>
                            <%= video.views %> views
                        </div>
                    </div>

                    <div class="col-md-4">
                        <%- include('../common/like') %>
                        <%- include('../common/dislike') %>
                    </div>

                    <div class="col-md-4">
                        <%- include('../common/subscribe') %>
                    </div>
                </div>

                <hr>

                <p class="text-center">
                    <b>Category : </b>
                    <a href="/video/search/category/<%= video.category %>">
                        <%= video.category %>
                    </a>
                </p>

                <hr>

                <p class="lead">
                    <%= video.description %>
                </p>

                <%- include('../common/comment') %>
            </div>

            <div class="col-md-4">
                <%- include('../common/side-bar') %>
            </div>
        </div>
    </div>
<%- include("../layouts/footer") %>

<% if (typeof isLogin !== 'undefined' && isLogin) { %>
    <script>
        window.onbeforeunload = function (event) {
            event.preventDefault();

            const videoPlayer = document.getElementById('videoPlayer');
            const watched = Math.floor(videoPlayer.currentTime);

            if (watched > 0) {
                const videoId = document.getElementById('videoId').value;
                const ajax = new XMLHttpRequest();

                ajax.open('POST', '/video/history', true);
                ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                ajax.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log(this.responseText);
                    }
                }

                ajax.send(`videoId=${videoId}&watched=${watched}`);
            }

            return (event.returnValue = 'Are you sure you want to exit?');
        };
    </script>
<% } %>