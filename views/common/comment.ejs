<div id="comments">
    <%
        video.comments = video.comments.reverse();

        video.comments.forEach(comment => {
    %>
        <div class="media mb-4">
            <img
                src="<%= comment.user.image %>"
                onerror="this.src = 'http://placehold.it/100x100'"
                alt="comment"
                class="d-flex mr-3 comment-img"
            >

            <div class="media-body">
                <h5 class="mt-0"><%= comment.user.name %></h5>
                <%= comment.comment %>

                <div id="replies">
                    <% if (isLogin) { %>
                        <div
                            style="float: right; cursor: pointer;"
                            onclick="createReplyNode(this);"
                            data-comment-id="<%= comment._id %>"
                        >
                            Reply
                        </div>
                    <% } %>

                    <% comment.replies.forEach(reply => { %>
                        <div class="media mt-4">
                            <img
                                src="<%= reply.user.image %>"
                                onerror="this.src = 'http://placehold.it/100x100'"
                                alt=""
                                class="d-flex mr-3 comment-img"
                            >
                            <div class="media-body">
                                <h5 class="mt-0"><%= reply.user.name %></h5>
                                <%= reply.reply %>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </div>
    <%
        });
    %>
</div>

<% if (typeof isLogin !== 'undefined' && isLogin) { %>
    <div class="card my-4">
        <div class="card-header">
            Leave a comment :
        </div>

        <div class="card-body">
            <form onsubmit="return postComment(this);">
                <div class="form-group">
                    <textarea name="comment" id="" cols="30" rows="10" class="form-control"></textarea>
                </div>

                <input type="submit" class="btn btn-primary" value="Post comment">
            </form>
        </div>
    </div>

    <script type="text/javascript">
        const createReplyNode = (self) => {
            const commentId = self.getAttribute("data-comment-id");
            let html = '';

            html += '<div class="row">';
            html += '<div class="col-md-12">';
            html += '<form onsubmit="return postReply(this);">';
            html += `<input type="hidden" name="commentId" value="${commentId}">`;
            html += `<div class="form-group">`;
            html += '<label>Write reply</label>';
            html += '<textarea class="form-control" name="reply" cols="25" rows="10"></textarea>';
            html += '</div>';
            html += `<button type="submit" class="btn btn-primary" data-comment-id=${commentId}>Reply</button>`;
            html += '</form>';
            html += '</div>';
            html += '</div>';

            self.innerHTML = html;
            self.removeAttribute('onclick');
        }

        const postReply = (form) => {
            const commentId = form.commentId.value;
            const reply = form.reply.value;
            const ajax = new XMLHttpRequest();

            ajax.open('POST', '/video/reply', true);
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            ajax.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    let html = '';

                    html += '<div class="media mt-4">';
                    html += '<img class="d-flex mr-3 comment-img" src="'
                        + response.user.image
                        + '" onerror="this.src = \'http://placehold.it/100x100\'">';
                    html += '<div class="media-body">';
                    html += `<h5 class="mt-0">${response.user.name}</h5>`;
                    html += form.reply.value;
                    html += '</div>';
                    html += '</div>';

                    document.getElementById("replies").innerHTML = html;
                    form.reply.value = '';
                }
            }

            ajax.send(`commentId=${commentId}&reply=${reply}`);
            return false;
        }

        const postComment = (self) => {
            const ajax = new XMLHttpRequest();
            const videoId = document.getElementById('videoId').value;

            ajax.open("POST", '/video/comment', true);
            ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            ajax.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let html = '';
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    html += '<div class="media mb-4">';
                    html += '<img class="d-flex mr-3 comment-img" src="'
                        + response.user.image
                        + '" onerror="this.src = \'http://placehold.it/100x100\'">';
                    html += '<div class="media-body">';
                    html += `<h5 class="mt-0">${response.user.name}</h5>`;
                    html += self.comment.value;
                    html += '</div>';
                    html += '</div>';

                    document.getElementById("comments").innerHTML = html + document.getElementById('comments').innerHTML;
                    self.comment.value = '';
                }
            }

            ajax.send(`videoId=${videoId}&comment=${self.comment.value}`);

            return false;
        }
    </script>
<% } %>