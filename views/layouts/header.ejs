<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MyVidd</title>
        <link rel="stylesheet" href="/public/vendor/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/public/css/alertify.min.css">
        <link rel="stylesheet" href="/public/css/macOSNotif.min.css">
        <link rel="stylesheet" href="/public/css/osahan.css">
        <link rel="stylesheet" href="/public/css/video-js.css">
        <link rel="stylesheet" href="/public/css/x0popup.min.css">
        <link rel="stylesheet" href="/public/vendor/fontawesome-free/css/all.min.css">
        <link rel="stylesheet" href="/public/css/custom.css">
    </head>

    <body>
        <%
        months = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
        ];

        baseUrl = 'http://localhost:3333/';
        %>
        <script type="text/javascript">
            const months = [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December"
            ];

            const baseUrl = 'http://localhost:3333/';
        </script>
        <nav class="navbar navbar-expland-lg navbar-dark bg-dark">
            <div class="container">
                <a href="/" class="navbar-brand">
                    Video Streaming
                </a>
                <div id="navbarResponsive">
                    <ul class="navbar-nav navbar-auth ml-auto">
                        <% if (typeof isLogin !== 'undefined' && isLogin) { %>
                            <script>
                                function readNotification(self) {
                                    const _id = self.getAttribute('data-id');
                                    const ajax = new XMLHttpRequest();
                                    
                                    ajax.open('POST', '/user/read-notification', true);
                                    ajax.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                                    ajax.onreadystatechange = function() {
                                        if (this.readyState == 4 && this.status == 200) {
                                            const response = JSON.parse(this.responseText);

                                            if (response.status == 'error') {
                                                alert(response.message);
                                            }
                                        }
                                    }

                                    ajax.send(`notificationId=${_id}`);
                                    return true;
                                }

                                var ajax = new XMLHttpRequest();

                                ajax.open("GET", '/user/get-user', true);

                                ajax.onreadystatechange = function() {
                                    if (this.readyState == 4 && this.status == 200) {
                                        const response = JSON.parse(this.responseText);
                                        
                                        if (response.status == 'success') {
                                            let html = '';
                                            window.user = response.user;

                                            html += '<div class="list-group list-group-flush">';
                                            html += `<a href="/channel/${window.user._id}" class="list-group-item list-group-item-action bg-light">My Channel</a>`;
                                            html += '</div>';

                                            document.getElementById('sidebar-wrapper').innerHTML += html;

                                            window.user.notification = window.user.notification.reverse();

                                            window.user.notification.forEach(notification => {
                                                if (!notification.is_read) {
                                                    if (notification.type == 'new_comment') {
                                                        html += '<a class="dropdown-item" onclick="return readNotification(this);" data-id="'
                                                            + notification._id + '" href="/watch/' + notification.video_watch + '">New comment</a>';
                                                    }
                                                }
                                            });

                                            document.getElementById("unread-notifications").innerHTML = html;
                                        } else {
                                            alert(response.message);
                                        }
                                    }
                                }

                                ajax.send();
                            </script>

                            <li class="nav-item">
                                <div class="dropdown">
                                    <button
                                        type="button"
                                        id="dropdownMenuButton"
                                        class="btn btn-secondary dropdown-toggle"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                    >
                                        <i class="fa fa-bell fa-fw" style="color: white;"></i>
                                    </button>

                                    <div
                                        class="dropdown-menu"
                                        id="unread-notifications"
                                        aria-labelledby="dropdownMenuButton"
                                    ></div>
                                </div>
                            </li>

                            <li class="nav-item">
                                <a href="/upload" class="nav-link">
                                    Upload Video
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/logout" class="nav-link">
                                    Logout
                                </a>
                            </li>
                        <% } else { %>
                            <li class="nav-item">
                                <a href="/login" class="nav-link">
                                    Login
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/signup" class="nav-link">
                                    SignUp
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </div>
            </div>
        </nav>

        
        <div class="d-flex" id="wrapper">
            <div class="bg-light border-right" id="sidebar-wrapper">
                <% if (typeof isLogin !== 'undefined' && isLogin) { %>
                    <div class="list-group list-group-flush">
                        <a href="/video/history/list" class="list-group-item list-group-item-action bg-light">History</a>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="/user/subscribed" class="list-group-item list-group-item-action bg-light">Subscribed Channel</a>
                    </div>
                <% } %>
            </div>